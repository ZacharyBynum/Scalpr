<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>scalpr_zen — Dashboard</title>
    <script src="https://unpkg.com/lightweight-charts@4/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0d1117;
            color: #c9d1d9;
            font-family: "Cascadia Code", "Fira Code", "JetBrains Mono", monospace;
            font-size: 14px;
            padding: 24px;
        }
        a { color: #58a6ff; }

        /* Header */
        .header {
            margin-bottom: 20px;
            border-bottom: 1px solid #21262d;
            padding-bottom: 16px;
        }
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #e6edf3;
            margin-bottom: 6px;
        }
        .header .subtitle {
            font-size: 13px;
            color: #7d8590;
        }
        .header .subtitle span {
            color: #c9d1d9;
        }

        /* Stat cards */
        .stats {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .stat-card {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 6px;
            padding: 12px 18px;
            flex: 1;
            min-width: 140px;
        }
        .stat-card .label {
            font-size: 11px;
            color: #7d8590;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .stat-card .value {
            font-size: 20px;
            font-weight: 600;
            color: #e6edf3;
        }
        .stat-card .value.positive { color: #3fb950; }
        .stat-card .value.negative { color: #f85149; }

        /* Chart containers */
        .section {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .section h2 {
            font-size: 14px;
            font-weight: 600;
            color: #e6edf3;
            margin-bottom: 12px;
        }
        #equity-chart {
            width: 100%;
            height: 360px;
        }

        /* Bottom row: two columns */
        .bottom-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        .winloss-chart-container {
            height: 260px;
        }

        /* Calendar heatmap */
        .heatmap-wrapper {
            overflow-x: auto;
        }
        .heatmap-months {
            display: flex;
            margin-bottom: 4px;
            margin-left: 32px;
            font-size: 11px;
            color: #7d8590;
        }
        .heatmap-body {
            display: flex;
        }
        .heatmap-day-labels {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-right: 4px;
            font-size: 10px;
            color: #7d8590;
        }
        .heatmap-day-labels span {
            height: 13px;
            line-height: 13px;
        }
        .heatmap-grid {
            display: grid;
            grid-template-rows: repeat(7, 13px);
            grid-auto-flow: column;
            grid-auto-columns: 13px;
            gap: 2px;
        }
        .heatmap-cell {
            width: 13px;
            height: 13px;
            border-radius: 2px;
            background: #161b22;
        }
        .heatmap-cell[data-pnl] {
            cursor: pointer;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: #1c2128;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 12px;
            color: #e6edf3;
            pointer-events: none;
            z-index: 100;
            display: none;
            white-space: nowrap;
        }

        /* Section divider */
        .section-divider {
            border: none;
            border-top: 1px solid #21262d;
            margin: 32px 0 24px;
        }
        .section-divider-label {
            font-size: 16px;
            font-weight: 600;
            color: #e6edf3;
            margin-bottom: 16px;
        }

        /* Monte Carlo chart */
        .mc-chart-container {
            position: relative;
            width: 100%;
            height: 420px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .data-table th, .data-table td {
            padding: 8px 12px;
            text-align: right;
            border-bottom: 1px solid #21262d;
        }
        .data-table th {
            color: #7d8590;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            background: #161b22;
            z-index: 1;
        }
        .data-table th:first-child, .data-table td:first-child {
            text-align: left;
        }
        .data-table td {
            color: #c9d1d9;
        }
        .data-table tbody tr:hover {
            background: #1c2128;
        }

        /* Trade log container */
        .trade-log-wrapper {
            max-height: 500px;
            overflow-y: auto;
        }
        .trade-log-wrapper::-webkit-scrollbar {
            width: 6px;
        }
        .trade-log-wrapper::-webkit-scrollbar-track {
            background: #0d1117;
        }
        .trade-log-wrapper::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 3px;
        }
        .trade-log-wrapper::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }

        /* Trade log search/filter bar */
        .trade-log-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
        }
        .trade-log-controls select,
        .trade-log-controls input {
            background: #0d1117;
            color: #c9d1d9;
            border: 1px solid #21262d;
            border-radius: 4px;
            padding: 6px 10px;
            font-family: inherit;
            font-size: 12px;
        }
        .trade-log-controls select:focus,
        .trade-log-controls input:focus {
            outline: none;
            border-color: #58a6ff;
        }
        .export-btn {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 6px 14px;
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .export-btn:hover {
            background: #30363d;
            border-color: #484f58;
        }
        .trade-count {
            font-size: 12px;
            color: #7d8590;
            margin-left: auto;
        }
    </style>
</head>
<body>

<div class="header">
    <h1>SCALPR ZEN v0.1 — Dashboard</h1>
    <div class="subtitle">
        <span>{{ result.strategy_name }}</span>
        &nbsp;|&nbsp; <span>{{ result.params.instrument }}</span>
        &nbsp;|&nbsp; EMA(<span>{{ result.params.fast_ema }}</span>/<span>{{ result.params.slow_ema }}</span>)
        &nbsp;|&nbsp; TP: <span>{{ result.params.tp_points }}</span> &nbsp; SL: <span>{{ result.params.sl_points }}</span>
        &nbsp;|&nbsp; {{ result.params.data_range }}
    </div>
</div>

{% if result.summary %}
{% set s = result.summary %}
<div class="stats">
    <div class="stat-card">
        <div class="label">Trades</div>
        <div class="value">{{ "{:,}".format(s.total_trades) }}</div>
    </div>
    <div class="stat-card">
        <div class="label">Win Rate</div>
        <div class="value">{{ "%.1f"|format(s.win_rate * 100) }}%</div>
    </div>
    <div class="stat-card">
        <div class="label">Total P&amp;L</div>
        <div class="value {{ 'positive' if s.total_pnl_dollars >= 0 else 'negative' }}">
            ${{ "{:,.0f}".format(s.total_pnl_dollars) }}
        </div>
    </div>
    <div class="stat-card">
        <div class="label">Profit Factor</div>
        <div class="value">{{ "%.2f"|format(s.profit_factor) }}</div>
    </div>
    <div class="stat-card">
        <div class="label">Max Drawdown</div>
        <div class="value negative">${{ "{:,.0f}".format(s.max_drawdown_dollars) }}</div>
    </div>
    <div class="stat-card">
        <div class="label">Sharpe Ratio</div>
        <div class="value">{{ "%.2f"|format(s.sharpe_ratio) }}</div>
    </div>
    <div class="stat-card">
        <div class="label">Avg MFE / MAE</div>
        <div class="value">{{ "%.2f"|format(s.avg_mfe_points) }} / {{ "%.2f"|format(s.avg_mae_points) }} pts</div>
    </div>
    <div class="stat-card">
        <div class="label">Buy &amp; Hold</div>
        <div class="value {{ 'positive' if s.buy_hold_pnl_dollars >= 0 else 'negative' }}">
            ${{ "{:,.0f}".format(s.buy_hold_pnl_dollars) }}
        </div>
    </div>
</div>
{% endif %}

<div class="section">
    <h2>Equity Curve <span style="font-size:12px;color:#7d8590;font-weight:400">— <span style="color:#3fb950">Strategy</span> vs <span style="color:#f0883e">Buy &amp; Hold</span></span></h2>
    <div id="equity-chart"></div>
</div>

<div class="bottom-row">
    <div class="section">
        <h2>Win / Loss Distribution</h2>
        <div class="winloss-chart-container">
            <canvas id="winloss-chart"></canvas>
        </div>
    </div>
    <div class="section">
        <h2>Daily P&amp;L Heatmap</h2>
        <div class="heatmap-wrapper">
            <div class="heatmap-months" id="heatmap-months"></div>
            <div class="heatmap-body">
                <div class="heatmap-day-labels">
                    <span></span>
                    <span>Mon</span>
                    <span></span>
                    <span>Wed</span>
                    <span></span>
                    <span>Fri</span>
                    <span></span>
                </div>
                <div class="heatmap-grid" id="heatmap-grid"></div>
            </div>
        </div>
    </div>
</div>

{% if mc %}
<hr class="section-divider">
<div class="section-divider-label">Monte Carlo Analysis <span style="font-size:12px;color:#7d8590;font-weight:400">— {{ "{:,}".format(mc.stats.n_simulations) }} simulations</span></div>

<div class="stats">
    <div class="stat-card">
        <div class="label">P(Profit)</div>
        <div class="value {{ 'positive' if mc.stats.probability_of_profit >= 0.5 else 'negative' }}">
            {{ "%.1f"|format(mc.stats.probability_of_profit * 100) }}%
        </div>
    </div>
    <div class="stat-card">
        <div class="label">Median P&amp;L</div>
        <div class="value {{ 'positive' if mc.stats.median_final_pnl >= 0 else 'negative' }}">
            ${{ "{:,.0f}".format(mc.stats.median_final_pnl) }}
        </div>
    </div>
    <div class="stat-card">
        <div class="label">90% CI Range</div>
        <div class="value">${{ "{:,.0f}".format(mc.stats.final_pnl_5th) }} to ${{ "{:,.0f}".format(mc.stats.final_pnl_95th) }}</div>
    </div>
    <div class="stat-card">
        <div class="label">Median Max DD</div>
        <div class="value negative">${{ "{:,.0f}".format(mc.stats.median_max_drawdown) }}</div>
    </div>
    <div class="stat-card">
        <div class="label">Worst DD (95th)</div>
        <div class="value negative">${{ "{:,.0f}".format(mc.stats.max_drawdown_95th) }}</div>
    </div>
</div>

<div class="section">
    <h2>Equity Curve Confidence Bands
        <span style="font-size:12px;color:#7d8590;font-weight:400">—
            <span style="color:rgba(88,166,255,0.3)">5th–95th</span> |
            <span style="color:rgba(88,166,255,0.6)">25th–75th</span> |
            <span style="color:#58a6ff">Median</span> |
            <span style="color:#3fb950">Original</span>
        </span>
    </h2>
    <div class="mc-chart-container">
        <canvas id="mc-chart"></canvas>
    </div>
</div>

<div class="section">
    <h2>Confidence Intervals</h2>
    <table class="data-table">
        <thead>
            <tr>
                <th>Percentile</th>
                <th>Final P&amp;L</th>
                <th>Max Drawdown</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>5th</td><td>${{ "{:,.0f}".format(mc.stats.final_pnl_5th) }}</td><td>${{ "{:,.0f}".format(mc.stats.max_drawdown_5th) }}</td></tr>
            <tr><td>25th</td><td>${{ "{:,.0f}".format(mc.stats.final_pnl_25th) }}</td><td>${{ "{:,.0f}".format(mc.stats.max_drawdown_25th) }}</td></tr>
            <tr><td>50th (Median)</td><td>${{ "{:,.0f}".format(mc.stats.median_final_pnl) }}</td><td>${{ "{:,.0f}".format(mc.stats.median_max_drawdown) }}</td></tr>
            <tr><td>75th</td><td>${{ "{:,.0f}".format(mc.stats.final_pnl_75th) }}</td><td>${{ "{:,.0f}".format(mc.stats.max_drawdown_75th) }}</td></tr>
            <tr><td>95th</td><td>${{ "{:,.0f}".format(mc.stats.final_pnl_95th) }}</td><td>${{ "{:,.0f}".format(mc.stats.max_drawdown_95th) }}</td></tr>
            <tr style="border-top:2px solid #30363d">
                <td style="color:#3fb950">Original</td>
                <td style="color:#3fb950">${{ "{:,.0f}".format(mc.stats.original_final_pnl) }}</td>
                <td style="color:#3fb950">${{ "{:,.0f}".format(mc.stats.original_max_drawdown) }}</td>
            </tr>
        </tbody>
    </table>
</div>
{% endif %}

{% if result.trades %}
<hr class="section-divider">
<div class="section">
    <h2>Trade Log</h2>
    <div class="trade-log-controls">
        <select id="filter-dir">
            <option value="all">All Directions</option>
            <option value="LONG">Long Only</option>
            <option value="SHORT">Short Only</option>
        </select>
        <select id="filter-exit">
            <option value="all">All Exits</option>
            <option value="TP">TP Only</option>
            <option value="SL">SL Only</option>
        </select>
        <button id="export-csv" class="export-btn">Export CSV</button>
        <span class="trade-count" id="trade-count"></span>
    </div>
    <div class="trade-log-wrapper">
        <table class="data-table" id="trade-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Dir</th>
                    <th>Entry Time</th>
                    <th>Entry Px</th>
                    <th>Exit Time</th>
                    <th>Exit Px</th>
                    <th>P&amp;L</th>
                    <th>Exit</th>
                    <th>MFE</th>
                    <th>MAE</th>
                </tr>
            </thead>
            <tbody id="trade-tbody"></tbody>
        </table>
    </div>
</div>
{% endif %}

<div class="tooltip" id="tooltip"></div>

<script>
const DATA = {{ result | tojson }};
{% if mc %}
const MC_DATA = {{ mc | tojson }};
{% endif %}

// ── Equity Curve (lightweight-charts) ──────────────────
(function() {
    const container = document.getElementById('equity-chart');
    const chart = LightweightCharts.createChart(container, {
        layout: {
            background: { color: '#161b22' },
            textColor: '#7d8590',
            fontFamily: '"Cascadia Code", monospace',
        },
        grid: {
            vertLines: { color: '#21262d' },
            horzLines: { color: '#21262d' },
        },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
        },
        rightPriceScale: {
            borderColor: '#21262d',
        },
        timeScale: {
            borderColor: '#21262d',
            timeVisible: false,
        },
    });

    const areaSeries = chart.addAreaSeries({
        topColor: 'rgba(63, 185, 80, 0.4)',
        bottomColor: 'rgba(63, 185, 80, 0.0)',
        lineColor: '#3fb950',
        lineWidth: 2,
    });

    areaSeries.setData(DATA.equity_curve);

    // Buy & hold overlay (LineStyle: 0=Solid, 1=Dotted, 2=Dashed)
    const buyHoldSeries = chart.addLineSeries({
        color: '#f0883e',
        lineWidth: 2,
        lineStyle: 2,
        crosshairMarkerVisible: false,
        lastValueVisible: true,
        priceLineVisible: false,
    });
    buyHoldSeries.setData(DATA.buy_hold_curve);

    chart.timeScale().fitContent();

    new ResizeObserver(() => {
        chart.applyOptions({ width: container.clientWidth });
    }).observe(container);
})();

// ── Win/Loss Distribution (Chart.js) ──────────────────
(function() {
    const ctx = document.getElementById('winloss-chart').getContext('2d');
    const wl = DATA.win_loss;

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['TP Long', 'SL Long', 'TP Short', 'SL Short'],
            datasets: [{
                data: [wl.tp_long, wl.sl_long, wl.tp_short, wl.sl_short],
                backgroundColor: ['#3fb950', '#f85149', '#3fb950', '#f85149'],
                borderRadius: 3,
                barPercentage: 0.7,
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1c2128',
                    borderColor: '#30363d',
                    borderWidth: 1,
                    titleFont: { family: '"Cascadia Code", monospace' },
                    bodyFont: { family: '"Cascadia Code", monospace' },
                    callbacks: {
                        label: function(ctx) {
                            return ctx.raw.toLocaleString() + ' trades';
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: '#21262d' },
                    ticks: {
                        color: '#7d8590',
                        font: { family: '"Cascadia Code", monospace' },
                        callback: function(v) { return v.toLocaleString(); }
                    }
                },
                y: {
                    grid: { display: false },
                    ticks: {
                        color: '#c9d1d9',
                        font: { family: '"Cascadia Code", monospace', size: 13 }
                    }
                }
            }
        }
    });
})();

// ── Daily P&L Heatmap ─────────────────────────────────
(function() {
    const grid = document.getElementById('heatmap-grid');
    const monthsEl = document.getElementById('heatmap-months');
    const tooltip = document.getElementById('tooltip');
    const dailyPnl = DATA.daily_pnl;

    if (dailyPnl.length === 0) return;

    // Build lookup
    const pnlMap = new Map();
    let maxAbs = 0;
    dailyPnl.forEach(d => {
        pnlMap.set(d.date, d.pnl);
        maxAbs = Math.max(maxAbs, Math.abs(d.pnl));
    });

    // Date range
    const firstDate = new Date(dailyPnl[0].date + 'T00:00:00Z');
    const lastDate = new Date(dailyPnl[dailyPnl.length - 1].date + 'T00:00:00Z');

    // Align to week start (Sunday)
    const start = new Date(firstDate);
    start.setUTCDate(start.getUTCDate() - start.getUTCDay());

    // Track month boundaries for labels
    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    let currentMonth = -1;
    let weekIndex = 0;
    const monthMarkers = [];

    // Create cells
    const current = new Date(start);
    while (current <= lastDate) {
        const dayOfWeek = current.getUTCDay();

        // Track week transitions for month labels
        if (dayOfWeek === 0) {
            const m = current.getUTCMonth();
            if (m !== currentMonth) {
                monthMarkers.push({ week: weekIndex, month: monthNames[m] });
                currentMonth = m;
            }
            weekIndex++;
        }

        const dateStr = current.toISOString().split('T')[0];
        const cell = document.createElement('div');
        cell.className = 'heatmap-cell';

        if (pnlMap.has(dateStr)) {
            const pnl = pnlMap.get(dateStr);
            const intensity = maxAbs > 0 ? Math.min(Math.abs(pnl) / maxAbs, 1) : 0;
            const alpha = 0.15 + intensity * 0.85;
            if (pnl >= 0) {
                cell.style.backgroundColor = `rgba(63, 185, 80, ${alpha})`;
            } else {
                cell.style.backgroundColor = `rgba(248, 81, 73, ${alpha})`;
            }
            cell.dataset.pnl = pnl.toFixed(2);
            cell.dataset.date = dateStr;
        } else {
            cell.style.backgroundColor = '#0d1117';
        }

        grid.appendChild(cell);
        current.setUTCDate(current.getUTCDate() + 1);
    }

    // Month labels
    const cellSize = 15; // 13px cell + 2px gap
    monthMarkers.forEach(m => {
        const span = document.createElement('span');
        span.textContent = m.month;
        span.style.position = 'absolute';
        span.style.left = (m.week * cellSize) + 'px';
        monthsEl.appendChild(span);
    });
    monthsEl.style.position = 'relative';
    monthsEl.style.height = '16px';

    // Tooltip
    grid.addEventListener('mouseover', function(e) {
        if (e.target.dataset.pnl) {
            const pnl = parseFloat(e.target.dataset.pnl);
            const sign = pnl >= 0 ? '+' : '';
            tooltip.textContent = e.target.dataset.date + ':  ' + sign + '$' + pnl.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            tooltip.style.display = 'block';
        }
    });
    grid.addEventListener('mousemove', function(e) {
        tooltip.style.left = (e.clientX + 12) + 'px';
        tooltip.style.top = (e.clientY - 8) + 'px';
    });
    grid.addEventListener('mouseout', function(e) {
        if (e.target.dataset.pnl) {
            tooltip.style.display = 'none';
        }
    });
})();

// ── Monte Carlo Chart ─────────────────────────────────
{% if mc %}
(function() {
    const ctx = document.getElementById('mc-chart').getContext('2d');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: MC_DATA.labels,
            datasets: [
                {
                    label: '95th percentile',
                    data: MC_DATA.curve_95th,
                    borderColor: 'transparent',
                    backgroundColor: 'rgba(88, 166, 255, 0.08)',
                    fill: '+4',
                    pointRadius: 0,
                    tension: 0.1,
                    order: 5,
                },
                {
                    label: '75th percentile',
                    data: MC_DATA.curve_75th,
                    borderColor: 'transparent',
                    backgroundColor: 'rgba(88, 166, 255, 0.15)',
                    fill: '+2',
                    pointRadius: 0,
                    tension: 0.1,
                    order: 4,
                },
                {
                    label: '50th percentile (Median)',
                    data: MC_DATA.curve_50th,
                    borderColor: '#58a6ff',
                    borderWidth: 2,
                    backgroundColor: 'transparent',
                    fill: false,
                    pointRadius: 0,
                    tension: 0.1,
                    order: 2,
                },
                {
                    label: '25th percentile',
                    data: MC_DATA.curve_25th,
                    borderColor: 'transparent',
                    backgroundColor: 'transparent',
                    fill: false,
                    pointRadius: 0,
                    tension: 0.1,
                    order: 4,
                },
                {
                    label: '5th percentile',
                    data: MC_DATA.curve_5th,
                    borderColor: 'transparent',
                    backgroundColor: 'transparent',
                    fill: false,
                    pointRadius: 0,
                    tension: 0.1,
                    order: 5,
                },
                {
                    label: 'Original',
                    data: MC_DATA.original,
                    borderColor: '#3fb950',
                    borderWidth: 2,
                    borderDash: [6, 3],
                    backgroundColor: 'transparent',
                    fill: false,
                    pointRadius: 0,
                    tension: 0.1,
                    order: 1,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1c2128',
                    borderColor: '#30363d',
                    borderWidth: 1,
                    titleFont: { family: '"Cascadia Code", monospace', size: 12 },
                    bodyFont: { family: '"Cascadia Code", monospace', size: 12 },
                    callbacks: {
                        title: function(items) {
                            return 'Trade #' + items[0].label;
                        },
                        label: function(ctx) {
                            const val = ctx.parsed.y;
                            const sign = val >= 0 ? '+' : '';
                            return ctx.dataset.label + ': ' + sign + '$' + val.toLocaleString(undefined, {maximumFractionDigits: 0});
                        }
                    },
                    filter: function(item) {
                        return item.dataset.borderColor !== 'transparent';
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: '#21262d' },
                    ticks: {
                        color: '#7d8590',
                        font: { family: '"Cascadia Code", monospace' },
                        maxTicksLimit: 10,
                    },
                    title: {
                        display: true,
                        text: 'Trade #',
                        color: '#7d8590',
                        font: { family: '"Cascadia Code", monospace', size: 12 }
                    }
                },
                y: {
                    grid: { color: '#21262d' },
                    ticks: {
                        color: '#7d8590',
                        font: { family: '"Cascadia Code", monospace' },
                        callback: function(v) {
                            const sign = v >= 0 ? '' : '-';
                            return sign + '$' + Math.abs(v).toLocaleString();
                        }
                    },
                    title: {
                        display: true,
                        text: 'Cumulative P&L ($)',
                        color: '#7d8590',
                        font: { family: '"Cascadia Code", monospace', size: 12 }
                    }
                }
            }
        }
    });
})();
{% endif %}

// ── Trade Log ─────────────────────────────────────────
(function() {
    const tbody = document.getElementById('trade-tbody');
    if (!tbody) return;

    const trades = DATA.trades;
    const dirFilter = document.getElementById('filter-dir');
    const exitFilter = document.getElementById('filter-exit');
    const countEl = document.getElementById('trade-count');

    function fmtDollar(v) {
        const sign = v >= 0 ? '+' : '';
        return sign + '$' + v.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function render() {
        const dv = dirFilter.value;
        const ev = exitFilter.value;
        const filtered = trades.filter(t =>
            (dv === 'all' || t.dir === dv) &&
            (ev === 'all' || t.exit === ev)
        );

        tbody.innerHTML = '';
        filtered.forEach(t => {
            const tr = document.createElement('tr');
            const pnlClass = t.pnl >= 0 ? 'positive' : 'negative';
            const dirColor = t.dir === 'LONG' ? '#58a6ff' : '#d2a8ff';
            const exitColor = t.exit === 'TP' ? '#3fb950' : '#f85149';
            tr.innerHTML =
                '<td>' + t.num + '</td>' +
                '<td style="color:' + dirColor + '">' + t.dir + '</td>' +
                '<td>' + t.entry_time + '</td>' +
                '<td>' + t.entry_price.toFixed(2) + '</td>' +
                '<td>' + t.exit_time + '</td>' +
                '<td>' + t.exit_price.toFixed(2) + '</td>' +
                '<td class="' + pnlClass + '">' + fmtDollar(t.pnl) + '</td>' +
                '<td style="color:' + exitColor + '">' + t.exit + '</td>' +
                '<td>' + t.mfe.toFixed(2) + '</td>' +
                '<td>' + t.mae.toFixed(2) + '</td>';
            tbody.appendChild(tr);
        });

        countEl.textContent = filtered.length + ' of ' + trades.length + ' trades';
    }

    dirFilter.addEventListener('change', render);
    exitFilter.addEventListener('change', render);
    render();

    // ── CSV Export ────────────────────────────────────
    document.getElementById('export-csv').addEventListener('click', function() {
        const rows = [];

        // Summary stats header block
        rows.push('# SCALPR ZEN — Backtest Export');
        rows.push('# Strategy,' + DATA.strategy_name);
        rows.push('# Instrument,' + (DATA.params.instrument || ''));
        rows.push('# EMA,' + (DATA.params.fast_ema || '') + '/' + (DATA.params.slow_ema || ''));
        rows.push('# TP Points,' + (DATA.params.tp_points || ''));
        rows.push('# SL Points,' + (DATA.params.sl_points || ''));
        rows.push('# Data Range,' + (DATA.params.data_range || ''));

        if (DATA.summary) {
            const s = DATA.summary;
            rows.push('#');
            rows.push('# SUMMARY');
            rows.push('# Total Trades,' + s.total_trades);
            rows.push('# Win Rate,' + (s.win_rate * 100).toFixed(1) + '%');
            rows.push('# Winning Trades,' + s.winning_trades);
            rows.push('# Losing Trades,' + s.losing_trades);
            rows.push('# Total PnL,$' + s.total_pnl_dollars.toFixed(2));
            rows.push('# Gross Profit,$' + s.gross_profit.toFixed(2));
            rows.push('# Gross Loss,$' + s.gross_loss.toFixed(2));
            rows.push('# Profit Factor,' + s.profit_factor.toFixed(2));
            rows.push('# Avg Win,$' + s.avg_win.toFixed(2));
            rows.push('# Avg Loss,$' + s.avg_loss.toFixed(2));
            rows.push('# Max Drawdown,$' + s.max_drawdown_dollars.toFixed(2));
            rows.push('# Max Consecutive Wins,' + s.max_consecutive_wins);
            rows.push('# Max Consecutive Losses,' + s.max_consecutive_losses);
            rows.push('# Sharpe Ratio,' + s.sharpe_ratio.toFixed(2));
            rows.push('# Avg MFE (pts),' + s.avg_mfe_points.toFixed(2));
            rows.push('# Avg MAE (pts),' + s.avg_mae_points.toFixed(2));
            rows.push('# Buy Hold PnL,$' + s.buy_hold_pnl_dollars.toFixed(2));
        }

        if (typeof MC_DATA !== 'undefined' && MC_DATA && MC_DATA.stats) {
            const m = MC_DATA.stats;
            rows.push('#');
            rows.push('# MONTE CARLO (' + m.n_simulations + ' simulations)');
            rows.push('# P(Profit),' + (m.probability_of_profit * 100).toFixed(1) + '%');
            rows.push('# Median Final PnL,$' + m.median_final_pnl.toFixed(2));
            rows.push('# Final PnL 5th,$' + m.final_pnl_5th.toFixed(2));
            rows.push('# Final PnL 25th,$' + m.final_pnl_25th.toFixed(2));
            rows.push('# Final PnL 75th,$' + m.final_pnl_75th.toFixed(2));
            rows.push('# Final PnL 95th,$' + m.final_pnl_95th.toFixed(2));
            rows.push('# Median Max DD,$' + m.median_max_drawdown.toFixed(2));
            rows.push('# Max DD 5th,$' + m.max_drawdown_5th.toFixed(2));
            rows.push('# Max DD 95th,$' + m.max_drawdown_95th.toFixed(2));
            rows.push('# Original Final PnL,$' + m.original_final_pnl.toFixed(2));
            rows.push('# Original Max DD,$' + m.original_max_drawdown.toFixed(2));
        }

        rows.push('#');

        // Trade data header + rows
        rows.push('trade_num,direction,entry_time,entry_price,exit_time,exit_price,pnl_dollars,exit_reason,mfe_points,mae_points');
        trades.forEach(t => {
            rows.push([
                t.num, t.dir, t.entry_time, t.entry_price.toFixed(2),
                t.exit_time, t.exit_price.toFixed(2), t.pnl.toFixed(2),
                t.exit, t.mfe.toFixed(2), t.mae.toFixed(2)
            ].join(','));
        });

        const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = DATA.strategy_name.replace(/\s+/g, '_').toLowerCase() + '_trades.csv';
        a.click();
        URL.revokeObjectURL(url);
    });
})();
</script>

</body>
</html>
